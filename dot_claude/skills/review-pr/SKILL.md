Review a GitHub PR with line-specific comments and code suggestions. Creates a PENDING review that the user must manually submit.

**Usage:** `/review-pr [instructions]`

All arguments are freeform: `$ARGUMENTS`

## Instructions

1. **Determine which PR to review:**
   - If arguments mention a PR number or URL, use that
   - If arguments mention a repo (owner/repo), use that
   - Otherwise, find the PR for the current branch:

     ```bash
     gh pr view --json number,headRefOid,url -q '.number'
     ```

   - If no PR exists for current branch, ask the user which PR to review

2. **Get PR context and sync local branch:**

   ```bash
   # Get PR details including branch name and commit SHA
   gh pr view <pr> --json headRefName,headRefOid,files -q '{branch: .headRefName, commit: .headRefOid, files: [.files[].path]}'

   # IMPORTANT: Fetch and checkout the latest version of the PR branch locally
   # This ensures line numbers match the PR diff exactly
   git fetch origin <branch>
   git checkout <branch>
   git pull origin <branch>

   # Get the diff
   gh pr diff <pr> --color never
   ```

   **Why sync the branch?** GitHub's review API requires line numbers that match the PR diff exactly. If your local copy is outdated, line numbers from local files won't match and the API will reject the comment with "Line could not be resolved".

3. **Determine review mode** based on `$ARGUMENTS`:

   **Mode A: Specific comments provided** - If the user provides specific issues to comment on (e.g., references a file with review items, or describes specific issues):
   - Proceed directly to step 5 to create the pending review

   **Mode B: Comprehensive review requested** - If no specific comments are provided:
   - Offer to perform a comprehensive review and write findings to a markdown file
   - Ask: "Would you like me to perform a comprehensive review and write findings to a file for you to review before submitting?"
   - If yes, proceed to step 4
   - If no, ask what specific aspects they want reviewed

4. **Write review findings to file** (Mode B only):
   - Analyze the PR for issues (bugs, style, security, performance, etc.)
   - Create a file named `<repo-name>-pr-<number>-review.md` in the current directory
   - Use this template:

   ```markdown
   # PR Review: #<number> - <title>

   **Repository:** <owner>/<repo>
   **Branch:** <branch>
   **Commit:** <sha>

   ## Review Items

   Mark items with [x] to include in the pending review. Edit suggestions as needed.

   ### Issue 1: <brief title>
   - [ ] **Include in review**
   - **File:** `<path>`
   - **Line(s):** <line> or <start_line>-<line>
   - **Severity:** High | Medium | Low
   - **Description:** <description>
   - **Suggestion:**

   ```
   <suggested code fix>
   ```

   ### Issue 2: <brief title>
   - [ ] **Include in review**
   ...

   ## Additional Instructions

   <!-- Add any additional instructions for Claude here -->

   ---
   When ready, ask Claude to submit the selected items as a pending review.
   ```

   - Tell the user: "I've written the review findings to `<repo-name>-pr-<number>-review.md`. Please review the file, mark items with [x] that you want included, and edit any suggestions. When ready, ask me to submit the selected items."
   - **Stop and wait** for the user to edit the file and ask for submission

5. **Analyze and prepare comments:**

   - **Prefer code suggestions**: Whenever pointing out an issue, provide a concrete fix using ` ```suggestion ` blocks
   - Only use plain comments when a suggestion isn't practical (e.g., asking a question, pointing out a design issue)
   - If processing a review file from step 4, only include items marked with [x]
   - Apply any additional instructions from the file

6. **Create a PENDING review with comments** using the GitHub API:

   ```bash
   gh api repos/{owner}/{repo}/pulls/{pr}/reviews -X POST --input - << 'EOF'
   {
     "commit_id": "<commit-sha>",
     "body": "Review summary here\n\n---\n_Generated by Claude Opus 4.5 (claude-opus-4-5-20251101)_",
     "comments": [
       {
         "path": "path/to/file.go",
         "line": 42,
         "body": "Your comment on line 42"
       },
       {
         "path": "path/to/file.go",
         "line": 50,
         "start_line": 45,
         "body": "Multi-line comment spanning lines 45-50"
       }
     ]
   }
   EOF
   ```

   **IMPORTANT:** Do NOT include `"event"` field - omitting it creates a PENDING review.

7. **Report to user:**
   - Confirm the pending review was created
   - List the comments added
   - Provide the PR URL for them to review and submit
   - **IMPORTANT (GitHub bug workaround):** The review body text often appears blank in the GitHub UI for pending reviews. Display the complete review summary text in a code block so the user can copy-paste it when submitting:
     ```
     **Review summary to copy-paste when submitting:**

     ```
     <the review body text here>
     ```
     ```

## Comment Types

### Single-line comment

```json
{
  "path": "src/handler.go",
  "line": 42,
  "body": "Consider adding error handling here."
}
```

### Multi-line comment

```json
{
  "path": "src/handler.go",
  "line": 50,
  "start_line": 45,
  "body": "This entire block could be simplified."
}
```

### Code suggestion

Use GitHub's suggestion markdown syntax in the `body`:

````json
{
  "path": "src/handler.go",
  "line": 42,
  "body": "Consider this improvement:\n\n```suggestion\nif err != nil {\n    return fmt.Errorf(\"failed to process: %w\", err)\n}\n```"
}
````

### Multi-line code suggestion

For replacing multiple lines, use `start_line` with suggestion:

````json
{
  "path": "src/handler.go",
  "line": 50,
  "start_line": 45,
  "body": "Simplify this block:\n\n```suggestion\nresult, err := doSomething(ctx)\nif err != nil {\n    return err\n}\n```"
}
````

## API Reference

### Comment parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| `path` | Yes | File path relative to repo root |
| `line` | Yes | Line number (or end line for multi-line) |
| `start_line` | No | Start line for multi-line comments |
| `body` | Yes | Comment text (supports markdown) |
| `side` | No | `LEFT` (deletion) or `RIGHT` (addition), defaults to RIGHT |
| `start_side` | No | Side for start_line, defaults to RIGHT |

## Best Practices

- **Always use suggestion blocks** when pointing out issues that have a concrete fix
- **Include attribution** in the review body: `_Generated by Claude Opus 4.5 (claude-opus-4-5-20251101)_`
- For multi-line replacements, use `start_line` + `line` with the suggestion block
- Only use plain comments for questions or high-level design feedback

## Important Notes

- Always creates PENDING reviews - user must submit manually
- Comments attach to specific lines in the PR diff
- Code suggestions use triple-backtick `suggestion` blocks
- For suggestions containing code blocks, use 4+ backticks
- The `line` parameter refers to the NEW file (right side of diff)
- Use `side: "LEFT"` to comment on deleted lines
