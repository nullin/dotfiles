#!/bin/bash
set -e

# Install Homebrew if not present
if ! command -v brew &>/dev/null; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install Nix if not present (Determinate Systems installer)
if ! command -v nix &>/dev/null; then
    curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install
fi

# Rebuild nix-darwin (installs all packages from configuration.nix)
if command -v darwin-rebuild &>/dev/null; then
    sudo darwin-rebuild switch --flake ~/.config/nix-darwin
fi
